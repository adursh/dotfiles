#!/usr/bin/env bash
# tsname — generate timestamped name or just timestamp, copy to clipboard, show notification
# Optional: -f to force silent copy (no notification)

set -u  # error on unset variables
set -o pipefail  # catch errors in piped commands

# ---- Bash guard ----
if [ -z "${BASH_VERSION:-}" ]; then
    echo "Error: tsname requires bash" >&2
    exit 99
fi

usage() {
    echo "Usage: tsname [-f] [prefix] [extension]" >&2
    echo "Example: tsname backup .tar.gz" >&2
    echo "Or just: tsname   → timestamp only" >&2
    echo "Optional -f: force silent clipboard copy (no notification)" >&2
}

# ---- Flags ----
force=false
args=()

for arg in "$@"; do
    case "$arg" in
        -f) force=true ;;
        -h|--help) usage; exit 0 ;;
        *) args+=("$arg") ;;
    esac
done

# ---- Input handling ----
prefix="${args[0]:-}"  # optional prefix
ext=""

if [ ${#args[@]} -ge 2 ]; then
    case "${args[1]}" in
        .*) ext="${args[1]}" ;;
        *)
            echo "Error: extension must start with a dot (e.g. .tar.gz)" >&2
            exit 3
            ;;
    esac
fi

# Reject unsafe prefix characters if prefix is given
if [ -n "$prefix" ]; then
    case "$prefix" in
        *[[:space:]/]*)
            echo "Error: prefix must not contain spaces or '/'" >&2
            exit 2
            ;;
    esac
fi

# ---- Timestamp ----
timestamp="$(date -u +%Y%m%dT%H%M%SZ)" || { echo "Error: failed to generate timestamp" >&2; exit 4; }

# ---- Compose name ----
if [ -n "$prefix" ]; then
    name="${prefix}-${timestamp}${ext}"
else
    name="$timestamp"
fi

# ---- Clipboard handling ----
copied=false

if command -v wl-copy >/dev/null 2>&1; then
    printf "%s" "$name" | wl-copy && copied=true
elif command -v pbcopy >/dev/null 2>&1; then
    printf "%s" "$name" | pbcopy && copied=true
elif command -v xclip >/dev/null 2>&1; then
    printf "%s" "$name" | xclip -selection clipboard && copied=true
fi

# ---- Notification ----
if [ "$force" = false ] && command -v notify-send >/dev/null 2>&1; then
    if [ "$copied" = true ]; then
        notify-send "Copied" "$name"
    else
        notify-send "tsname" "Generated: $name (clipboard not available)"
    fi
fi

# ---- Always print ----
echo "$name"
